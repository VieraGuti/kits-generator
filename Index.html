<script src="Items.js"></script>
    <script>
    let kitCounter = localStorage.getItem('kitCount') ? parseInt(localStorage.getItem('kitCount')) : 0;
    const allowedWearItems = [
        'gingerbreadsuit',
        'halloween.mummysuit',
        'scarecrow.suit',
        'scarecrowhead',
        'attire.bunny.onesie',
        'attire.bunnyears'
    ];

    function updateGalleryHeight() {
        const mainSlotsHeight = document.querySelector('.main-slots').offsetHeight;
        document.documentElement.style.setProperty('--main-slots-height', `${mainSlotsHeight}px`);
    }
	
	function makeItemContainerDraggable(itemContainer, slot) {
		itemContainer.draggable = true;
		
		itemContainer.addEventListener('dragstart', (e) => {
			itemContainer.classList.add('dragging');
			const data = {
				id: slot.dataset.id,
				quantity: slot.dataset.quantity,
				category: getItemCategory(slot.dataset.id),
				sourceType: slot.dataset.type
			};
			e.dataTransfer.setData('text/plain', JSON.stringify(data));
		});

		itemContainer.addEventListener('dragend', () => {
			itemContainer.classList.remove('dragging');
			document.querySelectorAll('.slot-highlight, .invalid-slot').forEach(el => {
				el.classList.remove('slot-highlight', 'invalid-slot');
			});
		});
	}
	
	function getItemCategory(itemId) {
		for (const [category, itemList] of Object.entries(items)) {
			if (itemList.some(item => item.id === itemId)) {
				return category;
			}
		}
		return null;
	}

    let preloadedImages = new Map();

    async function preloadImages() {
        const preloader = document.createElement('div');
        preloader.className = 'preloader';
        preloader.innerHTML = `
            <div class="preloader-content">
                <div class="preloader-spinner"></div>
                <div>Loading Images...</div>
                <div class="loading-progress">0%</div>
            </div>
        `;
        document.body.appendChild(preloader);

        const progressElement = preloader.querySelector('.loading-progress');
        let loadedCount = 0;
        let totalImages = 0;

        Object.values(items).forEach(category => {
            totalImages += category.length;
        });

        const loadPromises = [];

        for (const category of Object.values(items)) {
            for (const item of category) {
                const promise = new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        loadedCount++;
                        const progress = Math.round((loadedCount / totalImages) * 100);
                        progressElement.textContent = `${progress}%`;
                        preloadedImages.set(item.id, img);
                        resolve();
                    };
                    img.onerror = () => {
                        console.error(`Failed to load image: ${item.id}`);
                        resolve();
                    };
                    img.src = `images/${item.id}.png`;
                });
                loadPromises.push(promise);
            }
        }

        await Promise.all(loadPromises);
        
        document.body.removeChild(preloader);
    }

    window.onload = async function() {
        await preloadImages();
        loadCategories();
        updateGalleryHeight();
        
        const itemGallery = document.getElementById('itemGallery');
        const message = document.createElement('div');
        message.className = 'gallery-message';
        message.textContent = 'Select a category first';
        itemGallery.appendChild(message);
        
        window.addEventListener('resize', updateGalleryHeight);
    };

    function loadCategories() {
        const categorySelect = document.getElementById('category');
        Object.keys(items).forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });
    }
	
	function findFirstAvailableSlot(slotType) {
		const slots = document.querySelectorAll(`[data-type="${slotType}"]`);
		return Array.from(slots).find(slot => !slot.dataset.id);
	}

	function addDoubleClickHandler(imageItem, item, category) {
		imageItem.addEventListener('dblclick', () => {
			const isWearItem = isAllowedWearItem(item.id, category);
			let targetSlot = null;

			if (isWearItem) {
				targetSlot = findFirstAvailableSlot('wear');
			}

			if (!targetSlot) {
				targetSlot = findFirstAvailableSlot('main');
			}

			if (targetSlot) {
				applyItemToSlot(targetSlot, {
					id: item.id,
					category: category
				}, 1);
				updateKitCommands();
			} else {
				alert('No available slots for this item!');
			}
		});
	}

    const selectedItem = {
        id: null,
        category: null,
    };

    document.getElementById('kaosList').addEventListener('change', (event) => {
        const selectedKit = event.target.value;
        document.getElementById('kitName').value = selectedKit;
        updateKitCommands();
    });

    document.getElementById('kitName').addEventListener('input', (event) => {
        document.getElementById('kaosList').value = '';
        updateKitCommands();
    });

	document.getElementById('category').addEventListener('change', (event) => {
		const category = event.target.value;
		const itemGallery = document.getElementById('itemGallery');
		itemGallery.innerHTML = '';

		if (!category) {
			const message = document.createElement('div');
			message.className = 'gallery-message';
			message.textContent = 'Select a category first';
			itemGallery.appendChild(message);
			return;
		}

		if (items[category]) {
			items[category].forEach(item => {
				const imageItem = document.createElement('div');
				imageItem.className = 'image-item';
				imageItem.draggable = true;

				const img = document.createElement('img');
				if (preloadedImages.has(item.id)) {
					img.src = preloadedImages.get(item.id).src;
				} else {
					img.src = `images/${item.id}.png`;
				}
				img.alt = item.name;
				img.draggable = false;

				const itemName = document.createElement('div');
				itemName.className = 'item-name';
				itemName.textContent = item.name;

				imageItem.onclick = () => {
					if (imageItem.classList.contains('selected')) {
						let targetSlot = null;
						if (isAllowedWearItem(item.id, category)) {
							const wearSlots = document.querySelectorAll('[data-type="wear"]');
							targetSlot = Array.from(wearSlots).find(slot => !slot.dataset.id);
						}

						if (!targetSlot) {
							const mainSlots = document.querySelectorAll('[data-type="main"]');
							targetSlot = Array.from(mainSlots).find(slot => !slot.dataset.id);
						}

						if (targetSlot) {
							applyItemToSlot(targetSlot, {
								id: item.id,
								category: category
							}, 1);
							updateKitCommands();

						} else {
							alert('No available slots for this item!');
						}
					} else {
						const previouslySelected = document.querySelector('.image-item.selected');
						if (previouslySelected) {
							previouslySelected.classList.remove('selected');
						}
						selectedItem.id = item.id;
						selectedItem.category = category;
						imageItem.classList.add('selected');
					}
				};

				imageItem.addEventListener('dragstart', (e) => {
					imageItem.classList.add('dragging');
					e.dataTransfer.setData('text/plain', JSON.stringify({
						id: item.id,
						category: category,
						quantity: 1
					}));
				});

				imageItem.addEventListener('dragend', () => {
					imageItem.classList.remove('dragging');
					document.querySelectorAll('.slot-highlight, .invalid-slot').forEach(el => {
						el.classList.remove('slot-highlight', 'invalid-slot');
					});
				});

				imageItem.appendChild(img);
				imageItem.appendChild(itemName);
				itemGallery.appendChild(imageItem);
			});
		}
	});
	
    function isAllowedWearItem(itemId, category) {
        if (allowedWearItems.includes(itemId)) {
            return true;
        }
        
        if (category === 'ATTIRE') {
            return true;
        }
        
        return false;
    }

	function applyItemToSlot(slot, item, quantity) {
		if (slot.dataset.type === 'wear' && !isAllowedWearItem(item.id, item.category)) {
			alert('This item is not allowed in wear slots!');
			return false;
		}

		const itemContainer = document.createElement('div');
		itemContainer.className = 'item-container';

		const imgSlot = document.createElement('img');
		if (preloadedImages.has(item.id)) {
			imgSlot.src = preloadedImages.get(item.id).src;
		} else {
			imgSlot.src = `images/${item.id}.png`;
		}
		imgSlot.style.width = '100%';
		imgSlot.style.height = '100%';

		const controls = document.createElement('div');
		controls.className = 'slot-controls';

		const quantityDisplay = document.createElement('span');
		quantityDisplay.className = 'quantity-display';
		quantityDisplay.textContent = quantity;
		quantityDisplay.onclick = (e) => {
			e.stopPropagation();
			const newQuantity = prompt('Enter new quantity:', slot.dataset.quantity);
			if (newQuantity !== null && !isNaN(newQuantity) && newQuantity > 0) {
				slot.dataset.quantity = newQuantity;
				quantityDisplay.textContent = newQuantity;
				updateKitCommands();
			}
		};

		controls.appendChild(quantityDisplay);

		const removeBtn = document.createElement('button');
		removeBtn.className = 'remove-item';
		removeBtn.textContent = '×';
		removeBtn.onclick = (e) => {
			e.stopPropagation();
			slot.innerHTML = '';
			delete slot.dataset.id;
			delete slot.dataset.quantity;
			updateKitCommands();
		};

		itemContainer.appendChild(imgSlot);
		itemContainer.appendChild(controls);
		itemContainer.appendChild(removeBtn);

		makeItemContainerDraggable(itemContainer, slot);

		slot.innerHTML = '';
		slot.appendChild(itemContainer);

		slot.dataset.id = item.id;
		slot.dataset.quantity = quantity;

		return true;
	}

    function detectSlotType(slot) {
        if (slot.classList.contains('main-slot')) {
            return 'main';
        }
        if (slot.classList.contains('belt-slot')) {
            return 'belt';
        }
        if (slot.classList.contains('wear-slot')) {
            return 'wear';
        }
        return 'main';
    }

	const slots = document.querySelectorAll('.main-slot, .small-slot');
	slots.forEach(slot => {
		slot.addEventListener('dragover', (e) => {
			e.preventDefault();
			const data = JSON.parse(e.dataTransfer.getData('text/plain') || '{}');
			
			if (slot.dataset.type === 'wear' && !isAllowedWearItem(data.id, data.category)) {
				slot.classList.add('invalid-slot');
			} else {
				slot.classList.add('slot-highlight');
			}
		});

		slot.addEventListener('drop', (e) => {
			e.preventDefault();
			slot.classList.remove('slot-highlight', 'invalid-slot');
			
			const data = JSON.parse(e.dataTransfer.getData('text/plain'));
			
			if (slot.dataset.id) {
				const targetItem = {
					id: slot.dataset.id,
					quantity: slot.dataset.quantity,
					category: getItemCategory(slot.dataset.id)
				};
				
				const sourceSlot = Array.from(slots).find(s => 
					s.dataset.id === data.id && 
					s.dataset.quantity === data.quantity &&
					s.dataset.type === data.sourceType
				);
				
				if (sourceSlot) {
					const canMoveToTarget = slot.dataset.type !== 'wear' || 
						isAllowedWearItem(data.id, data.category);
					const canMoveToSource = sourceSlot.dataset.type !== 'wear' || 
						isAllowedWearItem(targetItem.id, targetItem.category);
					
					if (canMoveToTarget && canMoveToSource) {
						applyItemToSlot(sourceSlot, targetItem, targetItem.quantity);
						applyItemToSlot(slot, {
							id: data.id,
							category: data.category
						}, data.quantity);
						updateKitCommands();
					} else {
						alert('One or both items cannot be placed in the target slots!');
					}
				}
			} else {
				if (slot.dataset.type === 'wear' && !isAllowedWearItem(data.id, data.category)) {
					alert('This item is not allowed in wear slots!');
					return;
				}
				
				const sourceSlot = Array.from(slots).find(s => 
					s.dataset.id === data.id && 
					s.dataset.quantity === data.quantity &&
					s.dataset.type === data.sourceType
				);
				if (sourceSlot) {
					sourceSlot.innerHTML = '';
					delete sourceSlot.dataset.id;
					delete sourceSlot.dataset.quantity;
				}
				
				applyItemToSlot(slot, {
					id: data.id,
					category: data.category
				}, data.quantity);
				updateKitCommands();
			}
		});
	});

    function updateKitCommands() {
        const kitName = document.getElementById('kitName').value || document.getElementById('kaosList').value;
        
        if (!kitName) {
            document.getElementById('command_list').innerText = 'Enter a kit name to see commands...';
            return;
        }

        const commands = [];
        slots.forEach(slot => {
            if (slot.dataset.id) {
                const itemId = slot.dataset.id;
                const quantity = slot.dataset.quantity;
                const itemType = slot.dataset.type || 'Main';
                commands.push(`kit add "${kitName}" "${itemId}" ${quantity} 1 "${itemType}"`);
            }
        });
        
        if (commands.length === 0) {
            document.getElementById('command_list').innerText = 'Add items to your kit to see commands...';
            return;
        }
        
        document.getElementById('command_list').innerText = commands.join('\n');
    }

    let localCounter = localStorage.getItem('localKitCount') 
        ? parseInt(localStorage.getItem('localKitCount')) 
        : 0;
    document.getElementById('localCounter').textContent = localCounter;

    document.getElementById('copyCommands').addEventListener('click', async () => {
        const commandList = document.getElementById('command_list');
        if (!commandList.innerText.trim()) {
            alert('No commands to copy! Generate a kit first.');
            return;
        }
        
        try {
            const textarea = document.createElement('textarea');
            textarea.value = commandList.innerText;
            document.body.appendChild(textarea);
            
            textarea.select();
            document.execCommand('copy');
            
            document.body.removeChild(textarea);
            
            alert('Commands copied successfully!');
            
            localCounter++;
            localStorage.setItem('localKitCount', localCounter);
            document.getElementById('localCounter').textContent = localCounter;
            await updateGlobalCounter();
        } catch (err) {
            console.error('Error copying to clipboard:', err);
            alert('Error copying commands. Please try again.');
        }
    });

	document.getElementById('newKit').addEventListener('click', () => {
		document.getElementById('kitName').value = '';
		document.getElementById('kaosList').value = '';
		document.getElementById('category').value = '';
		
		document.querySelectorAll('.small-slot').forEach(slot => {
			slot.innerHTML = '';
			slot.dataset.type = 'wear';
			delete slot.dataset.id;
			delete slot.dataset.quantity;
		});

		document.querySelectorAll('.main-slot').forEach(slot => {
			slot.innerHTML = '';
			if (slot.closest('.slot-container').previousElementSibling.textContent.trim() === 'Belt') {
				slot.dataset.type = 'belt';
			} else {
				slot.dataset.type = 'main';
			}
			delete slot.dataset.id;
			delete slot.dataset.quantity;
		});
		
		const commandList = document.getElementById('command_list');
		commandList.innerText = '';
		
		selectedItem.id = null;
		selectedItem.category = null;
		
		const itemGallery = document.getElementById('itemGallery');
		itemGallery.innerHTML = '';
		const message = document.createElement('div');
		message.className = 'gallery-message';
		message.textContent = 'Select a category first';
		itemGallery.appendChild(message);
		
		const selectedItems = document.querySelectorAll('.image-item.selected');
		selectedItems.forEach(item => item.classList.remove('selected'));

		document.querySelectorAll('.slot-controls.active, .remove-item.active').forEach(control => {
			control.classList.remove('active');
		});
	});

    async function updateGlobalCounter() {
        try {
            const response = await fetch('counter.php', {
                method: 'POST'
            });
            const data = await response.json();
            document.getElementById('globalCounter').textContent = data.count;
        } catch (error) {
            console.error('Error updating global counter:', error);
        }
    }

    async function getGlobalCounter() {
        try {
            const response = await fetch('counter.php');
            const data = await response.json();
            document.getElementById('globalCounter').textContent = data.count;
        } catch (error) {
            console.error('Error getting global counter:', error);
        }
    }

	function parseSearchInput(input) {
		const match = input.match(/^(\d+)?\s*(.*)$/);
		if (match) {
			const quantity = match[1] ? parseInt(match[1]) : 1;
			const searchTerm = match[2].trim();
			return { quantity, searchTerm };
		}
		return { quantity: 1, searchTerm: input.trim() };
	}

	function getAllItems() {
		return Object.entries(items).flatMap(([category, itemList]) => 
			itemList.map(item => ({...item, category}))
		);
	}

	function updateGalleryWithSearch(input) {
		const itemGallery = document.getElementById('itemGallery');
		itemGallery.innerHTML = '';
		
		const { quantity, searchTerm } = parseSearchInput(input);
		
		if (!searchTerm) {
			const message = document.createElement('div');
			message.className = 'gallery-message';
			message.textContent = 'Select a category or search for items';
			itemGallery.appendChild(message);
			return { results: [], quantity: 1 };
		}

		const allItems = getAllItems();
		const searchResults = allItems.filter(item => 
			item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
			item.id.toLowerCase().includes(searchTerm.toLowerCase())
		);

		if (searchResults.length === 0) {
			const message = document.createElement('div');
			message.className = 'gallery-message';
			message.textContent = 'No matching items found';
			itemGallery.appendChild(message);
			return { results: [], quantity };
		}

		document.getElementById('category').value = '';

		searchResults.forEach(item => {
			const imageItem = document.createElement('div');
			imageItem.className = 'image-item';
			imageItem.draggable = true;

			const img = document.createElement('img');
			if (preloadedImages.has(item.id)) {
				img.src = preloadedImages.get(item.id).src;
			} else {
				img.src = `images/${item.id}.png`;
			}
			img.alt = item.name;
			img.draggable = false;

			const itemName = document.createElement('div');
			itemName.className = 'item-name';
			itemName.textContent = item.name;
			
			if (quantity > 1) {
				itemName.textContent = `${item.name} (×${quantity})`;
			}

			imageItem.onclick = () => {
				if (imageItem.classList.contains('selected')) {
					let targetSlot = null;
					if (isAllowedWearItem(item.id, item.category)) {
						const wearSlots = document.querySelectorAll('[data-type="wear"]');
						targetSlot = Array.from(wearSlots).find(slot => !slot.dataset.id);
					}
					if (!targetSlot) {
						const mainSlots = document.querySelectorAll('[data-type="main"]');
						targetSlot = Array.from(mainSlots).find(slot => !slot.dataset.id);
					}
					if (targetSlot) {
						applyItemToSlot(targetSlot, {
							id: item.id,
							category: item.category
						}, quantity);
						updateKitCommands();
					} else {
						alert('No available slots for this item!');
					}
				} else {
					const previouslySelected = document.querySelector('.image-item.selected');
					if (previouslySelected) {
						previouslySelected.classList.remove('selected');
					}
					selectedItem.id = item.id;
					selectedItem.category = item.category;
					imageItem.classList.add('selected');
				}
			};

			imageItem.addEventListener('dragstart', (e) => {
				imageItem.classList.add('dragging');
				e.dataTransfer.setData('text/plain', JSON.stringify({
					id: item.id,
					category: item.category,
					quantity: quantity
				}));
			});

			imageItem.addEventListener('dragend', () => {
				imageItem.classList.remove('dragging');
				document.querySelectorAll('.slot-highlight, .invalid-slot').forEach(el => {
					el.classList.remove('slot-highlight', 'invalid-slot');
				});
			});

			imageItem.appendChild(img);
			imageItem.appendChild(itemName);
			itemGallery.appendChild(imageItem);
		});

		return { results: searchResults, quantity };
	}
	
	const searchInput = document.getElementById('itemSearch');
	let searchTimeout = null;

	searchInput.addEventListener('input', (e) => {
		clearTimeout(searchTimeout);
		searchTimeout = setTimeout(() => {
			updateGalleryWithSearch(e.target.value);
		}, 300);
	});

	searchInput.addEventListener('keypress', (e) => {
		if (e.key === 'Enter') {
			const { results, quantity } = updateGalleryWithSearch(searchInput.value);
			if (results.length > 0) {
				const firstItem = results[0];
				let targetSlot = null;
				
				if (isAllowedWearItem(firstItem.id, firstItem.category)) {
					targetSlot = findFirstAvailableSlot('wear');
				}
				if (!targetSlot) {
					targetSlot = findFirstAvailableSlot('main');
				}
				
				if (targetSlot) {
					applyItemToSlot(targetSlot, {
						id: firstItem.id,
						category: firstItem.category
					}, quantity);
					updateKitCommands();
				} else {
					alert('No available slots for this item!');
				}
			}
		}
	});

	const originalResetHandler = document.getElementById('newKit').onclick;
	document.getElementById('newKit').onclick = () => {
		originalResetHandler();
		document.getElementById('itemSearch').value = '';
	};

    getGlobalCounter();
    </script>
